<script>
  (function () {
    const body = document.body;
    const siteHeader = document.querySelector('.site-header');
    const worksToggle = document.getElementById('works-toggle');
    const worksMenu = document.getElementById('works-menu');
    const worksItem = worksToggle ? worksToggle.closest('.nav-item--works') : null;
    const langButtons = Array.from(document.querySelectorAll('.lang-switch__btn'));
    const langSwitches = Array.from(document.querySelectorAll('.lang-switch'));
    const langHideTimers = new Map();
    const prefersHover = window.matchMedia('(hover: hover)');
    const mobileQuery = window.matchMedia('(max-width: 720px)');
    const tabletQuery = window.matchMedia('(max-width: 960px)');
    let hideMenuTimer;
    let lastScrollY = window.scrollY;
    let scrollTicking = false;

    const CLOSE_DELAY = 400;
    const SCROLL_DELTA = 6;
    const SHOW_THRESHOLD = 10;
    const HIDE_AFTER = 120;

    const openWorksMenu = () => {
      if (!worksItem || !worksMenu) return;
      window.clearTimeout(hideMenuTimer);
      worksMenu.classList.remove('is-hiding');
      worksItem.classList.add('is-open');
      worksMenu.setAttribute('aria-hidden', 'false');
      worksToggle?.setAttribute('aria-expanded', 'true');
      body.classList.add('works-menu-open');
      siteHeader?.classList.remove('is-hidden');
    };

    const setActiveLang = (lang) => {
      langButtons.forEach((btn) => {
        const isActive = btn.dataset.lang === lang;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });
    };

    const clearLangTimer = (sw) => {
      const timer = langHideTimers.get(sw);
      if (timer) {
        window.clearTimeout(timer);
        langHideTimers.delete(sw);
      }
    };

    const closeLangSwitches = (except) => {
      langSwitches.forEach((sw) => {
        if (sw !== except) {
          clearLangTimer(sw);
          sw.classList.remove('is-open');
        }
      });
    };

    langButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        const lang = btn.dataset.lang || 'en';
        setActiveLang(lang);
        closeLangSwitches();
      });
    });

    langSwitches.forEach((sw) => {
      sw.addEventListener('click', (event) => {
        if (event.target.closest('.lang-switch__btn')) return;
        const willOpen = !sw.classList.contains('is-open');
        closeLangSwitches();
        if (willOpen) sw.classList.add('is-open');
      });

      if (prefersHover.matches) {
        sw.addEventListener('pointerenter', () => {
          clearLangTimer(sw);
          closeLangSwitches(sw);
          sw.classList.add('is-open');
        });
        sw.addEventListener('pointerleave', () => {
          clearLangTimer(sw);
          const timer = window.setTimeout(() => {
            sw.classList.remove('is-open');
            langHideTimers.delete(sw);
          }, CLOSE_DELAY);
          langHideTimers.set(sw, timer);
        });
      }
    });

    document.addEventListener('pointerdown', (event) => {
      if (!langSwitches.length) return;
      if (event.target.closest('.lang-switch')) return;
      closeLangSwitches();
    });

    const initialLang = langButtons.find((btn) => btn.classList.contains('is-active'))?.dataset.lang || 'en';
    setActiveLang(initialLang);

    // Hero scatter gallery
    const heroGallery = document.querySelector('[data-hero-gallery]');
    if (heroGallery) {
      const stack = heroGallery.querySelector('.home-hero__gallery-stack');
      const mainImg = heroGallery.querySelector('[data-hero-gallery-main]');
      const dataImages = heroGallery.dataset.heroImages
        ? heroGallery.dataset.heroImages.split(',').map((src) => src.trim()).filter(Boolean)
        : [];
      const images = dataImages.length ? dataImages : (mainImg?.src ? [mainImg.src] : []);

      if (stack && images.length) {
        const fragment = document.createDocumentFragment();
        const total = Math.min(images.length, 30);
        for (let i = 0; i < total; i++) {
          const src = images[i % images.length];
          const img = new Image();
          img.src = src;
          const angle = Math.random() * Math.PI * 2;
          const radius = 25 + Math.random() * 35; // percentage
          const size = 20 + Math.random() * 14;
          const left = 50 + Math.cos(angle) * radius;
          const top = 50 + Math.sin(angle) * radius;
          img.style.top = `${top}%`;
          img.style.left = `${left}%`;
          img.style.width = `${size}%`;
          img.style.transform = `translate(-50%, -50%) rotate(${(-8 + Math.random() * 16).toFixed(1)}deg)`;
          img.loading = 'lazy';
          fragment.appendChild(img);
        }
        stack.appendChild(fragment);
      }
    }

    const closeWorksMenu = () => {
      if (!worksItem || !worksMenu) return;
      window.clearTimeout(hideMenuTimer);
      worksToggle?.setAttribute('aria-expanded', 'false');

      if (!worksItem.classList.contains('is-open')) {
        worksMenu.classList.remove('is-hiding');
        worksMenu.setAttribute('aria-hidden', 'true');
        body.classList.remove('works-menu-open');
        siteHeader?.classList.remove('is-hidden');
        return;
      }

      const startClosing = () => {
        worksItem.classList.remove('is-open');
        worksMenu.classList.add('is-hiding');

        const finishClosing = () => {
          worksMenu.classList.remove('is-hiding');
          worksMenu.setAttribute('aria-hidden', 'true');
          body.classList.remove('works-menu-open');
          siteHeader?.classList.remove('is-hidden');
        };

        worksMenu.addEventListener('animationend', finishClosing, { once: true });
        worksMenu.addEventListener('webkitAnimationEnd', finishClosing, { once: true });
      };

      hideMenuTimer = window.setTimeout(startClosing, CLOSE_DELAY);
    };

    const toggleWorksMenu = () => {
      if (!worksItem) return;
      const isOpen = worksItem.classList.contains('is-open');
      if (isOpen) closeWorksMenu(); else {
        worksMenu?.setAttribute('aria-hidden', 'false');
        openWorksMenu();
      }
    };

    if (worksMenu) {
      worksMenu.removeAttribute('hidden');
      worksMenu.setAttribute('aria-hidden', 'true');
    }

    worksToggle?.addEventListener('click', (event) => {
      event.preventDefault();
      toggleWorksMenu();
    });


    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') {
        closeWorksMenu();
      }
    });

    document.addEventListener('pointerdown', (event) => {
      if (!worksItem || !worksItem.classList.contains('is-open')) return;
      if (worksItem.contains(event.target)) return;
      closeWorksMenu();
    });

    worksMenu?.addEventListener('click', (event) => {
      const link = event.target.closest('a');
      if (link) {
        window.requestAnimationFrame(closeWorksMenu);
      }
    });

    const handleFocusIn = () => {
      worksMenu?.setAttribute('aria-hidden', 'false');
      openWorksMenu();
    };

    const handleFocusOut = (event) => {
      const nextFocus = event.relatedTarget;
      if (nextFocus && worksItem?.contains(nextFocus)) return;
      closeWorksMenu();
    };

    const updateFocusHandlers = () => {
      if (!worksItem) return;
      worksItem.removeEventListener('focusin', handleFocusIn);
      worksItem.removeEventListener('focusout', handleFocusOut);

      if (prefersHover.matches) {
        worksItem.addEventListener('focusin', handleFocusIn);
        worksItem.addEventListener('focusout', handleFocusOut);
      }
    };

    updateFocusHandlers();
    if (typeof prefersHover.addEventListener === 'function') {
      prefersHover.addEventListener('change', updateFocusHandlers);
    } else if (typeof prefersHover.addListener === 'function') {
      prefersHover.addListener(updateFocusHandlers);
    }

    if (worksItem && prefersHover.matches) {
      worksItem.addEventListener('pointerenter', (event) => {
        if (event.pointerType === 'touch' || tabletQuery.matches) return;
        worksMenu?.setAttribute('aria-hidden', 'false');
        openWorksMenu();
      });
      worksItem.addEventListener('pointerleave', (event) => {
        if (event.pointerType === 'touch' || tabletQuery.matches || mobileQuery.matches) return;
        closeWorksMenu();
      });
    }

    const handleDocumentPointerDown = (event) => {
      if (!worksItem || !mobileQuery.matches || !worksItem.classList.contains('is-open')) return;
      if (worksItem.contains(event.target)) return;
      closeWorksMenu();
    };

    mobileQuery.addEventListener('change', (event) => {
      if (!worksItem) return;
      document.removeEventListener('pointerdown', handleDocumentPointerDown, true);
      if (event.matches) {
        closeWorksMenu();
        document.addEventListener('pointerdown', handleDocumentPointerDown, true);
      }
    });

    tabletQuery.addEventListener('change', (event) => {
      if (!worksItem) return;
      if (event.matches) closeWorksMenu();
    });

    if (mobileQuery.matches) {
      document.addEventListener('pointerdown', handleDocumentPointerDown, true);
    }

    const updateHeaderOnScroll = () => {
      if (!siteHeader) {
        scrollTicking = false;
        return;
      }
      const currentY = window.scrollY;
      const delta = currentY - lastScrollY;
      const menuOpen = body.classList.contains('works-menu-open');

      if (currentY < SHOW_THRESHOLD || delta < -SCROLL_DELTA || menuOpen) {
        siteHeader.classList.remove('is-hidden');
      } else if (delta > SCROLL_DELTA && currentY > HIDE_AFTER) {
        siteHeader.classList.add('is-hidden');
      }

      lastScrollY = currentY;
      scrollTicking = false;
    };

    window.addEventListener('scroll', () => {
      if (scrollTicking) return;
      scrollTicking = true;
      window.requestAnimationFrame(updateHeaderOnScroll);
    }, { passive: true });

    window.addEventListener('resize', () => {
      lastScrollY = window.scrollY;
      siteHeader?.classList.remove('is-hidden');
    });

    updateHeaderOnScroll();

    const backToTop = document.getElementById('back-to-top');
    const moreInfoToggles = document.querySelectorAll('[data-more-info-toggle]');
    const reduceMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    const scrollTargets = [
      document.getElementById('content'),
      document.scrollingElement,
      document.documentElement,
      document.body
    ].filter((target, index, array) => target && array.indexOf(target) === index);

    const getScrollTop = () => {
      const values = scrollTargets.map((target) => ('scrollTop' in target) ? target.scrollTop : 0);
      values.push(window.scrollY || window.pageYOffset || 0);
      return Math.max(...values);
    };

    const setScrollTop = (value) => {
      scrollTargets.forEach((target) => {
        if (!target) return;
        if (typeof target.scrollTo === 'function') {
          target.scrollTo(0, value);
        } else if ('scrollTop' in target) {
          target.scrollTop = value;
        }
      });
      window.scrollTo(0, value);
    };

    const animateScrollToTop = (duration = 1000) => {
      const startY = getScrollTop();
      if (startY <= 0) return;
      if (reduceMotionQuery.matches) {
        setScrollTop(0);
        return;
      }

      const startTime = performance.now();

      const step = (now) => {
        const elapsed = Math.min((now - startTime) / duration, 1);
        const eased = 1 - Math.pow(1 - elapsed, 3);
        setScrollTop(startY * (1 - eased));
        if (elapsed < 1) window.requestAnimationFrame(step);
      };

      window.requestAnimationFrame(step);
    };

    backToTop?.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      animateScrollToTop(1000);
    });

    moreInfoToggles.forEach((button) => {
      const targetId = button.getAttribute('aria-controls');
      if (!targetId) return;
      const target = document.getElementById(targetId);
      if (!target) return;

      const collapsedLabel = button.dataset.labelCollapsed || 'More info';
      const expandedLabel = button.dataset.labelExpanded || 'Less info';

      const getCollapsedValue = () => {
        const value = window.getComputedStyle(target).getPropertyValue('--more-info-collapsed');
        return (value && value.trim()) || '18rem';
      };

      const forceReflow = () => { void target.getBoundingClientRect(); };

      const onTransitionEnd = (event) => {
        if (event.propertyName !== 'max-height') return;
        target.removeEventListener('transitionend', onTransitionEnd);
        const expanded = button.getAttribute('aria-expanded') === 'true';
        target.style.maxHeight = expanded ? 'none' : '';
      };

      const animateExpand = () => {
        target.style.maxHeight = getCollapsedValue();
        forceReflow();
        target.classList.add('is-expanded');
        target.style.maxHeight = `${target.scrollHeight}px`;
      };

      const animateCollapse = () => {
        target.style.maxHeight = `${target.scrollHeight}px`;
        forceReflow();
        target.classList.remove('is-expanded');
        target.style.maxHeight = getCollapsedValue();
      };

      const setExpanded = (expanded, { animate } = { animate: true }) => {
        button.setAttribute('aria-expanded', String(expanded));
        button.textContent = expanded ? expandedLabel : collapsedLabel;

        target.removeEventListener('transitionend', onTransitionEnd);

        if (!animate || reduceMotionQuery.matches) {
          target.classList.toggle('is-expanded', expanded);
          target.style.maxHeight = expanded ? 'none' : '';
          return;
        }

        target.addEventListener('transitionend', onTransitionEnd);

        if (expanded) {
          animateExpand();
        } else {
          animateCollapse();
        }
      };

      setExpanded(false, { animate: false });

      button.addEventListener('click', () => {
        const expanded = button.getAttribute('aria-expanded') === 'true';
        setExpanded(!expanded);
      });
    });
  })();
</script>

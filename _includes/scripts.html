<script>
  (function () {
    const body = document.body;
    const overlay = document.querySelector('.nav-overlay');
    const links = document.querySelectorAll('.left-nav a');
    const workLink = document.getElementById('work-link');

    const open = () => {
      body.classList.add('nav-open');
      body.classList.remove('hide-header');
    };
    const close = () => {
      body.classList.remove('nav-open');
    };

    if (workLink) {
      workLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (body.classList.contains('nav-open')) close(); else open();
      });
    }
    if (overlay) overlay.addEventListener('click', close);
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
    links.forEach((a) => a.addEventListener('click', close));

    // Mobile subpages: hide header on scroll down, show on scroll up
    const isHome = body.classList.contains('home');
    const mq = window.matchMedia('(max-width: 768px)');
    let lastY = window.scrollY;
    let ticking = false;
    function onScroll() {
      if (!mq.matches || isHome || body.classList.contains('nav-open')) return;
      const y = window.scrollY;
      const delta = y - lastY;
      // Near top always show
      if (y < 10) {
        body.classList.remove('hide-header');
        lastY = y;
        return;
      }
      if (delta > 4) {
        body.classList.add('hide-header'); // scrolling down
      } else if (delta < -4) {
        body.classList.remove('hide-header'); // scrolling up
      }
      lastY = y;
    }
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => { onScroll(); ticking = false; });
        ticking = true;
      }
    }, { passive: true });
    window.addEventListener('resize', () => { body.classList.remove('hide-header'); });

    const moreInfoToggles = document.querySelectorAll('[data-more-info-toggle]');
    const reduceMotionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');

    moreInfoToggles.forEach((button) => {
      const targetId = button.getAttribute('aria-controls');
      if (!targetId) return;
      const target = document.getElementById(targetId);
      if (!target) return;

      const collapsedLabel = button.dataset.labelCollapsed || 'More info';
      const expandedLabel = button.dataset.labelExpanded || 'Less info';

      const getCollapsedValue = () => {
        const value = window.getComputedStyle(target).getPropertyValue('--more-info-collapsed');
        return (value && value.trim()) || '18rem';
      };

      const forceReflow = () => { void target.getBoundingClientRect(); };

      const onTransitionEnd = (event) => {
        if (event.propertyName !== 'max-height') return;
        target.removeEventListener('transitionend', onTransitionEnd);
        const expanded = button.getAttribute('aria-expanded') === 'true';
        target.style.maxHeight = expanded ? 'none' : '';
      };

      const animateExpand = () => {
        target.style.maxHeight = getCollapsedValue();
        forceReflow();
        target.classList.add('is-expanded');
        target.style.maxHeight = `${target.scrollHeight}px`;
      };

      const animateCollapse = () => {
        target.style.maxHeight = `${target.scrollHeight}px`;
        forceReflow();
        target.classList.remove('is-expanded');
        target.style.maxHeight = getCollapsedValue();
      };

      const setExpanded = (expanded, { animate } = { animate: true }) => {
        button.setAttribute('aria-expanded', String(expanded));
        button.textContent = expanded ? expandedLabel : collapsedLabel;

        target.removeEventListener('transitionend', onTransitionEnd);

        if (!animate || reduceMotionQuery.matches) {
          target.classList.toggle('is-expanded', expanded);
          target.style.maxHeight = expanded ? 'none' : '';
          return;
        }

        target.addEventListener('transitionend', onTransitionEnd);

        if (expanded) {
          animateExpand();
        } else {
          animateCollapse();
        }
      };

      setExpanded(false, { animate: false });

      button.addEventListener('click', () => {
        const expanded = button.getAttribute('aria-expanded') === 'true';
        setExpanded(!expanded);
      });
    });
  })();
</script>
